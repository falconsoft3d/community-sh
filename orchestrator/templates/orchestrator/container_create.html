{% extends "orchestrator/base.html" %}

{% block content %}
<div class="flex flex-col gap-6 max-w-4xl">
    <div class="flex items-center gap-4">
        <a href="{% url 'container-list' %}"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 w-10">
            <i data-lucide="arrow-left" class="h-4 w-4"></i>
        </a>
        <div>
            <h1 class="text-3xl font-bold tracking-tight">Create Container</h1>
            <p class="text-muted-foreground mt-2">Choose a template or create a custom container</p>
        </div>
    </div>

    <form method="post"
        x-init="{% if first_template %}updateFields('{{ first_template.key }}', {{ first_template.port }}, '{{ first_template.image }}', {{ first_template.container_port }}, '{{ first_template.description|escapejs }}', '{{ first_template.raw_yaml|escapejs }}'){% endif %}"
        x-data="{
        template: 'custom',
        customPort: 8000,
        containerPort: 80,
        image: '',
        description: '',
        containerName: '',
        rawYaml: '',
        editMode: 'simple', // 'simple' or 'yaml'
        suggestName() {
            // Suggest container name based on template
            if (this.template !== 'custom') {
                this.containerName = this.template;
            } else {
                this.containerName = '';
            }
        },
        updateFields(key, port, img, cPort, desc, yaml) {
            this.template = key;
            this.customPort = port;
            this.image = img;
            this.containerPort = cPort;
            this.description = desc;
            this.rawYaml = yaml;
            this.suggestName();
        }
    }">
        {% csrf_token %}

        <!-- Template Selection -->
        <div class="rounded-xl border bg-card text-card-foreground shadow-sm mb-6">
            <div class="p-6 border-b">
                <h3 class="font-semibold text-lg">Select Template</h3>
                <p class="text-sm text-muted-foreground">Choose a pre-configured template or create a custom container
                </p>
            </div>
            <div class="p-6">
                <div class="grid md:grid-cols-2 gap-4">
                    {% for key, tmpl in templates.items %}
                    <label class="relative flex cursor-pointer rounded-lg border p-4 hover:bg-accent transition-colors">
                        <input type="radio" name="template" value="{{ key }}" x-model="template"
                            @change="updateFields('{{ key }}', {{ tmpl.port }}, '{{ tmpl.image }}', {{ tmpl.container_port }}, '{{ tmpl.description|escapejs }}', '{{ tmpl.raw_yaml|escapejs }}')"
                            class="sr-only peer" {% if forloop.first %}checked{% endif %}>
                        <div class="flex items-start gap-3 w-full">
                            <div
                                class="h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
                                <i data-lucide="box" class="h-5 w-5 text-primary"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold">{{ tmpl.name }}</h4>
                                <p class="text-sm text-muted-foreground">{{ tmpl.description }}</p>
                                <p class="text-xs text-muted-foreground mt-1">Port: {{ tmpl.port }}</p>
                            </div>
                        </div>
                        <div
                            class="absolute inset-0 rounded-lg border-2 border-transparent peer-checked:border-primary pointer-events-none">
                        </div>
                    </label>
                    {% endfor %}

                    <label class="relative flex cursor-pointer rounded-lg border p-4 hover:bg-accent transition-colors">
                        <input type="radio" name="template" value="custom" x-model="template"
                            @change="updateFields('custom', 8000, '', 80, '', '')" class="sr-only peer">
                        <div class="flex items-start gap-3 w-full">
                            <div
                                class="h-10 w-10 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0">
                                <i data-lucide="settings" class="h-5 w-5 text-gray-600"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold">Custom</h4>
                                <p class="text-sm text-muted-foreground">Configure your own container</p>
                            </div>
                        </div>
                        <div
                            class="absolute inset-0 rounded-lg border-2 border-transparent peer-checked:border-primary pointer-events-none">
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Mode Selection Tabs -->
        <div class="flex items-center gap-2 mb-4 bg-muted p-1 rounded-lg w-fit">
            <button type="button" @click="editMode = 'simple'"
                :class="editMode === 'simple' ? 'bg-background shadow-sm' : 'hover:bg-background/50'"
                class="px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2">
                <i data-lucide="sliders" class="h-4 w-4"></i>
                Configuration
            </button>
            <button type="button" @click="editMode = 'yaml'"
                :class="editMode === 'yaml' ? 'bg-background shadow-sm' : 'hover:bg-background/50'"
                class="px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2">
                <i data-lucide="file-code" class="h-4 w-4"></i>
                YAML Editor
            </button>
        </div>

        <!-- Container Configuration (Simple Mode) -->
        <div x-show="editMode === 'simple'" x-transition
            class="rounded-xl border bg-card text-card-foreground shadow-sm mb-6">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="font-semibold text-lg">Configuration</h3>
                <span class="text-xs font-mono px-2 py-1 bg-muted rounded" x-text="'Template: ' + template"></span>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="name" class="text-sm font-medium">Container Name <span
                                class="text-destructive">*</span></label>
                        <input type="text" id="name" name="name" required x-model="containerName"
                            class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                            placeholder="my-container">
                    </div>

                    <div class="space-y-2">
                        <label for="image" class="text-sm font-medium">Docker Image <span
                                class="text-destructive">*</span></label>
                        <input type="text" id="image" name="image" required x-model="image"
                            class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                            placeholder="nginx:latest">
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="port" class="text-sm font-medium">Host Port <span
                                class="text-destructive">*</span></label>
                        <input type="number" id="port" name="port" x-model="customPort" required
                            class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                    </div>

                    <div class="space-y-2">
                        <label for="container_port" class="text-sm font-medium">Container Port <span
                                class="text-destructive">*</span></label>
                        <input type="number" id="container_port" name="container_port" x-model="containerPort" required
                            class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                    </div>
                </div>

                <div class="space-y-2">
                    <label for="description" class="text-sm font-medium">Description</label>
                    <textarea id="description" name="description" rows="3" x-model="description"
                        class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"></textarea>
                </div>
            </div>
        </div>

        <!-- YAML Editor (Advanced Mode) -->
        <div x-show="editMode === 'yaml'" x-transition
            class="rounded-xl border bg-card text-card-foreground shadow-sm mb-6">
            <div class="p-6 border-b flex items-center justify-between">
                <h3 class="font-semibold text-lg">YAML Template Editor</h3>
                <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-medium">Advanced mode</span>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label for="yaml_config" class="text-sm font-medium">Template YAML Content</label>
                        <textarea id="yaml_config" name="yaml_config" rows="15" x-model="rawYaml"
                            class="flex w-full rounded-md border border-input bg-zinc-950 text-zinc-50 font-mono px-4 py-3 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                            placeholder="# YAML configuration here..."></textarea>
                        <p class="text-xs text-muted-foreground mt-2">
                            <i data-lucide="info" class="inline h-3 w-3 mr-1"></i>
                            Editing YAML allows you to modify environment variables, volumes, and networks directly.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <button type="submit"
                class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                <i data-lucide="play" class="mr-2 h-4 w-4"></i>
                Create & Start Container
            </button>
            <a href="{% url 'container-list' %}"
                class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}